<UserControl
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="clr-namespace:osuautodeafen.cs.ViewModels"
    xmlns:anim="https://github.com/whistyun/AnimatedImage.Avalonia"
    xmlns:helpers="clr-namespace:osuautodeafen.cs.Helpers"
    xmlns:changelog="clr-namespace:osuautodeafen.cs.Changelog"
    x:Class="osuautodeafen.Views.ChangelogView"
    x:DataType="vm:ChangelogViewModel">


    <UserControl.Resources>
        <helpers:TextBeforePrConverter x:Key="TextBeforePrConverter" />
        <helpers:TextAfterPrConverter x:Key="TextAfterPrConverter" />
    </UserControl.Resources>

    <UserControl.DataTemplates>

        <DataTemplate DataType="vm:ChangelogViewModel+CodeBlockModel">
            <Border Margin="16,6"
                    Padding="10"
                    Background="#101010"
                    CornerRadius="6">
                <TextBlock Text="{Binding Code}"
                           FontFamily="Consolas"
                           FontSize="12"
                           Foreground="#DCDCDC"
                           TextWrapping="Wrap" />
            </Border>
        </DataTemplate>

        <DataTemplate DataType="vm:ChangelogViewModel+QuoteBlockModel">
            <Border Margin="16,4"
                    Padding="10"
                    BorderThickness="3,0,0,0"
                    BorderBrush="MediumPurple"
                    Background="#0D0D0D">
                <TextBlock Text="{Binding Text}"
                           Foreground="#CCCCCC"
                           FontStyle="Italic"
                           TextWrapping="Wrap" />
            </Border>
        </DataTemplate>

        <DataTemplate DataType="vm:ChangelogViewModel+TextBlockModel">
            <TextBlock Text="{Binding Text}"
                       TextWrapping="Wrap"
                       Foreground="#E8E8E8"
                       Margin="16,2" />
        </DataTemplate>

        <DataTemplate
            x:DataType="vm:ChangelogViewModel+BulletBlockModel"
            DataType="vm:ChangelogViewModel+BulletBlockModel">

            <TextBlock Margin="16,2"
                       TextWrapping="Wrap"
                       Foreground="#E8E8E8">

                <TextBlock.Inlines>
                    <Run Text="• " />
                    <Run Text="{Binding Text, Converter={StaticResource TextBeforePrConverter}}" />
                    <InlineUIContainer BaselineAlignment="Center">
                        <Button
                            Command="{Binding OpenPrCommand}"
                            IsVisible="{Binding HasPr}"
                            Padding="0"
                            Margin="0"
                            PointerEntered="PrButton_PointerEntered"
                            PointerExited="PrButton_PointerExited"
                            PointerMoved="PrButton_PointerMoved"
                            Background="Transparent"
                            BorderThickness="0"
                            VerticalAlignment="Center">
                            <TextBlock
                                Text="{Binding PrNumber}"
                                FontSize="{Binding $parent[TextBlock].FontSize}"
                                Foreground="DarkOrchid"
                                Cursor="Hand"
                                VerticalAlignment="Center" />
                            <Button.Styles>
                                <Style Selector="Button:pointerover TextBlock">
                                    <Setter Property="Foreground" Value="MediumPurple" />
                                </Style>
                            </Button.Styles>
                        </Button>
                    </InlineUIContainer>
                    <Run Text="{Binding Text, Converter={StaticResource TextAfterPrConverter}}" />
                </TextBlock.Inlines>

            </TextBlock>
        </DataTemplate>

        <DataTemplate DataType="vm:ChangelogViewModel+InlineTextBlockModel">
            <TextBlock
                Margin="16,2"
                TextWrapping="Wrap"
                Foreground="#E8E8E8"
                AttachedToVisualTree="InlineText_Attached">

                <TextBlock.Tag>
                    <Binding Path="Inlines" />
                </TextBlock.Tag>

            </TextBlock>
        </DataTemplate>

        <DataTemplate
            x:DataType="changelog:TextPart"
            DataType="changelog:TextPart">
            <Run Text="{Binding Text}" />
        </DataTemplate>

        <DataTemplate x:DataType="changelog:LinkPart">
            <InlineUIContainer BaselineAlignment="Center">
                <Button
                    Command="{Binding OpenLinkCommand}"
                    Tag="{Binding Url}"
                    Padding="0"
                    Background="Transparent"
                    BorderThickness="0"
                    Cursor="Hand">
                    <TextBlock
                        Text="{Binding Text}"
                        Foreground="MediumPurple"
                        TextDecorations="Underline"
                        FontSize="{Binding $parent[TextBlock].FontSize}" />
                </Button>
            </InlineUIContainer>
        </DataTemplate>

        <DataTemplate DataType="vm:ChangelogViewModel+ImageBlockModel">
            <Border Margin="16,8"
                    CornerRadius="6"
                    ClipToBounds="True">
                <Image Source="{Binding Source}"
                       MaxWidth="460"
                       Stretch="Uniform" />
            </Border>
        </DataTemplate>

        <DataTemplate DataType="vm:ChangelogViewModel+VideoPreviewBlockModel">
            <StackPanel AttachedToVisualTree="VideoPreview_AttachedToVisualTree">
                <Border Height="260"
                        CornerRadius="8"
                        ClipToBounds="True"
                        Background="#0A0A0A">
                    <Grid>

                        <Image anim:ImageBehavior.AnimatedSource="{Binding PreviewPath}"
                               anim:ImageBehavior.RepeatBehavior="Forever"
                               Stretch="UniformToFill" />
                        <Button Command="{Binding OpenVideoCommand}"
                                Width="28"
                                Height="28"
                                CornerRadius="14"
                                Background="#99000000"
                                BorderThickness="0"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Top"
                                Margin="8"
                                Cursor="Hand"
                                PointerEntered="VideoRedirect_PointerEntered"
                                PointerExited="VideoRedirect_PointerExited"
                                PointerMoved="VideoRedirect_PointerMoved">
                            <TextBlock Text="↗"
                                       Foreground="White"
                                       FontSize="14" />
                        </Button>
                    </Grid>
                </Border>
                <ProgressBar Height="4"
                             IsVisible="{Binding IsEncoding}"
                             Margin="0,6,0,0"
                             Minimum="0"
                             Maximum="1"
                             Value="{Binding Progress}"
                             Background="#333333"
                             Foreground="#4CAF50" />
            </StackPanel>
        </DataTemplate>

        <DataTemplate DataType="vm:ChangelogViewModel+DividerBlockModel">
            <Border Height="1"
                    Margin="0,10"
                    Background="#33FFFFFF" />
        </DataTemplate>

    </UserControl.DataTemplates>

    <Grid>
        <Border Width="520"
                MaxHeight="600"
                CornerRadius="14"
                Background="#CC0F0F0F"
                BorderBrush="#40FFFFFF"
                BorderThickness="1"
                Padding="24">

            <Border CornerRadius="10"
                    Background="#FF151515"
                    Padding="20">

                <Grid RowDefinitions="Auto,*,Auto"
                      RowSpacing="18">

                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                        <TextBlock Text="Changelog"
                                   FontSize="26"
                                   FontWeight="SemiBold"
                                   Foreground="White"
                                   HorizontalAlignment="Left" />
                        <TextBlock Text="{Binding Entries[0].Version}"
                                   Grid.Column="1"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Foreground="#AAAAAA"
                                   VerticalAlignment="Center"
                                   HorizontalAlignment="Right" />
                    </Grid>

                    <ScrollViewer Grid.Row="1"
                                  VerticalScrollBarVisibility="Auto">

                        <ItemsControl ItemsSource="{Binding Entries}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Spacing="18">
                                        <ItemsControl ItemsSource="{Binding Sections}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Spacing="10">
                                                        <TextBlock Text="{Binding Title}"
                                                                   FontSize="14"
                                                                   FontWeight="SemiBold"
                                                                   Foreground="#CFCFCF"
                                                                   Margin="0,12,0,4" />
                                                        <ItemsRepeater ItemsSource="{Binding Blocks}">
                                                            <ItemsRepeater.Layout>
                                                                <StackLayout Spacing="10" />
                                                            </ItemsRepeater.Layout>
                                                            <ItemsRepeater.ItemTemplate>
                                                                <DataTemplate>
                                                                    <ContentControl Content="{Binding}" />
                                                                </DataTemplate>
                                                            </ItemsRepeater.ItemTemplate>
                                                        </ItemsRepeater>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                    </ScrollViewer>

                    <Button Grid.Row="2"
                            Content="Ok"
                            Width="100"
                            HorizontalAlignment="Right"
                            Command="{Binding DismissCommand}" />

                </Grid>
            </Border>
        </Border>
    </Grid>
</UserControl>